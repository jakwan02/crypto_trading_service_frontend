# Agent Guide (frontend)

> 이 문서는 “프론트 확장 시 정합성/UX/i18n/에러 처리”를 깨지 않기 위한 고정 규칙이다.
> 충돌 시 우선순위: 코드 > 백엔드 계약(backend/docs/CONTRACTS.md) > 이 문서.

## 0) 기본 원칙(강제)
1) **서버 메시지/코드 그대로 노출 금지(PROD)**
   - `error.message`, `error.code`, raw payload를 화면에 직접 출력하지 않는다.
   - 표준 처리: `src/components/common/ApiErrorView.tsx`의 코드→문구/CTA 매핑으로 흡수한다.

2) **i18n 정합(키 노출 재발 방지)**
   - i18n key는 `<namespace>.<keyPath>` 이며, namespace는 locale 파일 최상위 키다.
   - init.ns는 `resources.ko` 기반 자동 구성(누락 방지) → 하드코딩 ns 목록으로 회귀 금지.
   - 신규 UI 문구는 ko/en 동시 추가(키 누락 금지).

3) **페이지/컴포넌트 스타일 정합**
   - 신규 페이지는 `docs/UI_GUIDE.md`의 카드/버튼/테이블/레이아웃 토큰을 그대로 사용한다.
   - “예외 스타일”이 필요하면 공통 컴포넌트로 승격해 중복을 만들지 않는다.

4) **결제/권한은 서버 SoT**
   - 결제 성공은 리다이렉트 결과가 아니라 `/app/billing/checkout/*/status` 또는 `/app/billing/me`로 확정한다.
   - 상태 확정 후 `AuthContext.refresh()`로 권한을 동기화한다.

5) **느린 UX는 optimistic으로 개선**
   - 토글(즐겨찾기 등)은 optimistic update + 실패 롤백을 기본으로 한다.

## 1) 문서 사용 규칙
- 새 작업 시작:
  - `docs/CONTEXT.md`, `docs/RECENT.md`
- URL/프록시/WS 문제:
  - `docs/ENV.md` + `backend/docs/reverse_proxy_caddy.md`
- i18n 문제:
  - `docs/I18N.md`
- 에러 UX:
  - `docs/ERROR_UX.md`
- 결제/사용량/워치리스트 흐름:
  - `docs/WORKFLOWS.md`

## 2) 변경 체크리스트(작업 종료 시)
- i18n 키 추가/변경이 있으면:
  - `src/i18n/locales/ko.ts`, `src/i18n/locales/en.ts` 동시 반영
  - `docs/I18N.md` 갱신 필요 여부 확인
- 에러 UX 변경이 있으면:
  - `docs/ERROR_UX.md` 갱신
- base URL/WS URL 처리 변경이 있으면:
  - `docs/ENV.md` 갱신
- `codex_log.md` 템플릿대로 append

## Appendix) 매 채팅 시작 지침(고정) v5 (copy/paste)

[핵심 원칙]
- 한국어로만 답변한다.
- 내 요구사항에 대한 “정확한 답”만 제공한다(불필요한 반복/장문 금지).
- 추측 금지: 근거는 반드시 “레포 내부: 파일 경로 + 라인(또는 함수/클래스명)” 또는 “로그/출력”으로 제시한다.
- 원인/해결은 최선안 1가지만 제시한다(대안 나열 금지).

[프로젝트 정합성(기업급, 강제)]
- (공통) 기존 실행 중 로직은 기본적으로 삭제/축약/기능 제거 금지. 필요 시 “추가(append) + 호환 유지 + 점진 전환”.
- (백엔드) DB/Redis/Streams/스냅샷/모니터링은 가용성 우선: 락/폭주/연결 고갈/키 폭증/복구 루프 폭주를 유발하는 변경 금지.
- (프론트) 서버 응답/에러 원문(error.message/code/payload)을 PROD UI에 그대로 노출 금지. 모든 케이스(성공/실패/대기/제한/권한)를 사용자 친화 UX로 매핑.
- (설계/계약) 인터페이스(REST/WS/Redis/DB) 변경 시 계약 문서와 타입/UX까지 함께 정합 유지.

[컨텍스트/탐색 규칙 (중요: 사용자에게 파일 붙여넣기 요구 금지)]
- 새 작업 시작 시 기본 컨텍스트: `docs/CONTEXT.md` + `docs/RECENT.md`를 먼저 읽고 판단한다.
- 그 다음 필요한 파일만 직접 열어 확인한다(사용자에게 “전체 내용 붙여넣기” 요구 금지).
- Alembic head(revision id), 대상 파일/함수, md 파일 내용은 레포에서 직접 확인한다.
- 사용자에게 요청 가능한 입력은 “레포 밖에서만 확인 가능한 것”으로 제한한다.
  - 예: 운영 DB 상태, 컨테이너 상태/로그, 실행 에러(10~30줄), 네트워크/방화벽/DNS

[Codex 실행 정책(필수)]
- Codex는 파일 수정(패치 생성)을 수행한다.
- 검증은 사용자가 실행한다.
  - 실패 시: 핵심 에러 10~30줄만 전달
  - 성공 시: 성공 결과 1줄만 전달

[변경 범위/금지]
- 사용자가 지정한 파일/폴더만 수정한다.
- 범위 확장이 필요하면 즉시 승인 요청을 한다(아래 승인 규칙 준수).
- 의존성 추가는 정말 필요할 때만(필요 시 설치/적용 커맨드까지 함께 제시).

[승인(동의) 요청 규칙 — 중요]
- 아래 항목이 필요하다고 판단되면 즉시 중단하고 “승인 요청 메시지”만 출력한다.
  1) 파일 삭제
  2) 모듈 분리/대규모 이동
  3) 대규모 구조 변경
  4) 기존 로직 삭제/축약(기능 제거 포함)
  5) 수정 범위 확대(지정 범위 밖 수정)
  6) DB 스키마/Alembic 마이그레이션 추가(또는 다운타임/부하 위험 작업)
- 승인 요청 메시지 형식(고정):
  1) 왜 필요한가(근거 1~2줄: 파일/라인 또는 로그)
  2) 무엇을 바꾸는가(파일/변경 요약 3줄 이내)
  3) 영향(리스크/롤백 포인트 2줄 이내)
  4) 내가 “승인”이라고 답하면 진행, 아니면 현재 범위 내 최선안으로만 진행

[출력 방식(토큰 절약 + 정확성)]
- 기본 응답은 “패치(변경 부분 중심)”로 제공한다.
- “전체 코드/전체 파일”은 사용자가 명시 요구한 경우에만 제공한다.
- 변경 이유는 변경 지점 바로 위에 한 줄로만 남긴다.
  - 예: `# 변경 이유: 주간 버킷 기준을 월요일 00:00 UTC로 통일`

[증거 제시 방식(근거 부족 최소화)]
- 레포 내부 근거는 반드시 파일/라인(또는 함수/클래스명)로 제시한다(“근거 부족” 남발 금지).
- “근거 부족”은 레포 외부(운영 환경/실행 결과/네트워크/방화벽/도메인 DNS 등)에서만 사용한다.
- 검증은 “실행 명령 + 정상/비정상 기준 1줄”로 최소 제공한다.

[운영/배포(도커) — 해당 시 필수]
- 도커 이미지 재빌드/컨테이너 재기동/프로파일 변경/마이그레이션이 필요·권장되면, 내가 실행할 정확한 명령어를 원문 그대로 포함한다.
- 불필요하면 “도커 재빌드/재기동: 불필요(이유 1줄)”을 반드시 명시한다.
- 데이터 유실 위험 작업(예: `down -v`, 볼륨 삭제)은 사전 경고(위험 1줄 + 영향 1줄) 후 커맨드를 제시한다.

[문서/로그 동기화]
- 코드 변경이 있는 작업을 완료하면 `docs/RECENT.md`와 프로젝트 루트 `codex_log.md`에 1건 append를 기본 수행한다(기존 내용 수정 금지).
- 사용자가 문서/로그 변경 금지를 명시하면 승인 요청 규칙을 따른다.

[응답 포맷(항상 고정)]
1) 수정 파일 목록(경로만)
2) 핵심 변경 요약(최대 5줄)
3) 내가 실행할 명령 + 정상/비정상 기준(최소)
4) `RECENT.md` / `codex_log.md` 반영 요약(각 1줄, 해당 시)
5) 제안 커밋 메시지 1줄
